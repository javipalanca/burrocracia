<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>Burrocracia</title>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet"
		  integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"
			integrity="sha384-w76AqPfDkMBDXo30jS1Sgez6pr3x5MlQ1ZAGC+nuZB+EYdgRZgiwxhTBTkF7CXvN"
			crossorigin="anonymous"></script>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.3.0/css/all.min.css"
		  integrity="sha512-SzlrxWUlpfuzQ+pcUCosxcglQRNAq/DZjVsC0lE40xsADsfeQoEypE+enwcOiGjk/bSuGGKHEyjSoQ1zVisanQ=="
		  crossorigin="anonymous" referrerpolicy="no-referrer"/>
</head>
<body>
<div class="container">
	<header class="d-flex flex-wrap justify-content-center py-3 mb-4 border-bottom">
		<a href="/" class="d-flex align-items-center mb-3 mb-md-0 me-md-auto text-dark text-decoration-none">
			<i class="fa fa-democrat fa-4x"></i>
			<h1>Burrocracia</h1>&nbsp;<span class="fs-4">(el solver para DEDICA)</span>
		</a>

		<ul class="nav nav-pills">
			<li class="nav-item"><a href="/" class="nav-link active" aria-current="page">Home</a></li>
			<li class="nav-item"><a href="#" class="nav-link">About</a></li>
		</ul>
	</header>
</div>
<div class="container">
	<main>
		<div class="py-5 text-center">
			<i class="fa fa-democrat fa-8x"></i>
			<h2>Establecer horas</h2>
			<p class="lead">Establece las horas mínimas por proyecto de investigación y para docencia para el periodo
				seleccionado.</p>
		</div>

		<div class="row g-5">
			<div class="col-md-7 col-lg-8">
				<h4 class="mb-3">Establece las horas a dedicar por proyecto en el periodo {{ period }}.</h4>
				<form action="/solve" method="post">
					<div class="row g-3">
						<ul class="list-group mb-3">

							{% for key, value in questions.items() %}
							<li class="list-group-item d-flex justify-content-between lh-sm">
								{% if key.0 == '__empty__' %}
								<div class="alert alert-danger" role="alert">
									{{ value }}
								</div>
								{% else %}
								<div class="col-md-10">
									<label for="{{ key }}" class="col-form-label">{{ value }}</label>
								</div>
								<div class="col-md-2">
									<input type="number" min="-1" step="0.5" value="0" class="form-control"
										   id="{{ key }}"
										   name="{{ key }}">
								</div>
								{% endif %}
								{% endfor %}
							</li>
						</ul>
					</div>

					<hr class="my-4">

					<input type="hidden" name="filename" value="{{ filename }}">
					<button class="w-100 btn btn-primary btn-lg" type="submit">Generar CSV</button>
				</form>
			</div>

			<div class="col-md-5 col-lg-4">
				<div class="card mb-3">
					<div class="card-body">
						<h5 class="card-title">Resumen</h5>
						<p class="card-text">Periodo: <strong>{{ period }}</strong></p>
						<p class="card-text">Días laborables: <strong id="num-days">{{ num_working_days }}</strong></p>
						<p class="card-text">Horas máximas mes: <strong id="max-hours">{{ max_hours_month }}</strong></p>
						<p class="card-text">Horas asignadas: <strong id="assigned-hours">0</strong></p>
						<p class="card-text">Horas restantes: <strong id="remaining-hours">{{ max_hours_month }}</strong></p>
					</div>
				</div>
				<div class="card">
					<div class="card-body">
						<h5 class="card-title">Previsualización</h5>
						<div id="preview-table-container">
							<table class="table table-sm" id="preview-table">
								<thead><tr><th>Proyecto</th><th>WP</th><th>Horas</th></tr></thead>
								<tbody></tbody>
							</table>
						</div>
					</div>
				</div>
			</div>
		</div>
	</main>
	<div class="container">
		<footer class="d-flex flex-wrap justify-content-between align-items-center py-3 my-4 border-top">
			<p class="col-md-4 mb-0 text-muted">© 2023 GTI-IA / VRAIN</p>

			<a href="/"
			   class="col-md-4 d-flex align-items-center justify-content-center mb-3 mb-md-0 me-md-auto link-dark text-decoration-none">
				<svg class="bi me-2" width="40" height="32">
					<use xlink:href="#bootstrap"></use>
				</svg>
			</a>
		</footer>
	</div>
</div>

</body>
<script>
// Dynamic update of assigned and remaining hours and preview table
document.addEventListener('DOMContentLoaded', function () {
	const inputs = Array.from(document.querySelectorAll('input[type=number]'));
	const maxHours = parseFloat(document.getElementById('max-hours').innerText);
	const assignedEl = document.getElementById('assigned-hours');
	const remainingEl = document.getElementById('remaining-hours');
	const previewBody = document.querySelector('#preview-table tbody');
	const numDays = parseInt(document.getElementById('num-days').innerText);
	// existing totals injected from server
	const existingTotal = parseFloat('{{ existing_total }}');
	const existingByActivity = {{ existing_by_activity|tojson }};

	function update() {
		// start from existing hours present in CSV
		let total = existingTotal || 0;
		previewBody.innerHTML = '';

		const rows = [];
		const freeProjectRows = [];

		// First pass: compute contributions from special activities and fixed project totals
		inputs.forEach(input => {
			if (input.name === 'filename' || input.name === 'submit') return;
			let val = input.value === '' ? null : parseFloat(input.value);

			// parse display name and wp
			let name = input.name;
			let proj = name;
			let wp = '';
			if (name.startsWith('(') && name.includes(',')) {
				let s = name.replace(/[()"']/g, '');
				let parts = s.split(',');
				proj = parts[0];
				wp = parts[1] ? parts[1].trim() : '';
			}

			const specialKeys = ['__teaching__','__other_id__','__other__','__lessons__'];
			const keyFound = specialKeys.find(k => input.name.includes(k));

			if (keyFound) {
				const existingActTotal = parseFloat(existingByActivity[keyFound] || 0);
				if (val !== null && !isNaN(val) && val >= 0) {
					const targetTotal = Math.max(existingActTotal, val * numDays);
					total += (targetTotal - existingActTotal);
					rows.push({proj, wp, display: targetTotal.toFixed(1)});
				} else {
					// show existing total for -1 or empty
					rows.push({proj, wp, display: (existingActTotal).toFixed(1)});
				}
			} else {
				// regular project
				if (val === -1) {
					// mark as free project to be estimated later
					freeProjectRows.push({proj, wp, input});
					rows.push({proj, wp, display: ''});
				} else if (val !== null && !isNaN(val) && val >= 0) {
					total += val;
					rows.push({proj, wp, display: val.toFixed(1)});
				} else {
					rows.push({proj, wp, display: ''});
				}
			}
		});

		// Estimate allocation for free projects (-1): distribute remaining capacity equally
		let remainingCapacity = maxHours - total;
		if (freeProjectRows.length > 0 && remainingCapacity > 0) {
			const per = remainingCapacity / freeProjectRows.length;
			// update corresponding rows (they are in same order as rows array)
			let freeIndex = 0;
			for (let i = 0; i < rows.length; i++) {
				if (rows[i].display === '') {
					// could be either empty input or a free project; check matching by proj/wp
					// if freeProjectRows has this proj/wp, assign
					const fp = freeProjectRows[freeIndex];
					if (fp && rows[i].proj === fp.proj && rows[i].wp === fp.wp) {
						rows[i].display = per.toFixed(1);
						total += per;
						freeIndex++;
						if (freeIndex >= freeProjectRows.length) break;
					}
				}
			}
		}

		// Render rows
		rows.forEach(r => {
			if (r.proj !== 'filename') {
				const tr = document.createElement('tr');
				const tdProj = document.createElement('td'); tdProj.textContent = r.proj;
				const tdWp = document.createElement('td'); tdWp.textContent = r.wp;
				const tdVal = document.createElement('td'); tdVal.textContent = r.display;
				tr.appendChild(tdProj); tr.appendChild(tdWp); tr.appendChild(tdVal);
				previewBody.appendChild(tr);
			}
		});

		assignedEl.textContent = total.toFixed(1);
		const remaining = (maxHours - total);
		remainingEl.textContent = remaining.toFixed(1);
		if (remaining < 0) {
			remainingEl.classList.add('text-danger');
		} else {
			remainingEl.classList.remove('text-danger');
		}
	}

	// Replace local calculation with server-side preview for exact match
	const debounce = (fn, wait) => {
		let t = null;
		return (...args) => {
			if (t) clearTimeout(t);
			t = setTimeout(() => fn(...args), wait);
		};
	};

	async function fetchPreview() {
		const form = new FormData();
		// include filename
		const filenameInput = document.querySelector('input[name="filename"]');
		if (filenameInput) form.append('filename', filenameInput.value);
		inputs.forEach(input => {
			if (input.name === 'submit') return;
			form.append(input.name, input.value);
		});
		try {
			const resp = await fetch('/preview', {method: 'POST', body: form});
			if (!resp.ok) {
				const j = await resp.json();
				console.error('Preview error', j);
				return;
			}
			const data = await resp.json();
			// render preview table
			previewBody.innerHTML = '';
			data.rows.forEach(r => {
				const tr = document.createElement('tr');
				const tdProj = document.createElement('td'); tdProj.textContent = r.project;
				const tdWp = document.createElement('td'); tdWp.textContent = r.wp;
				const tdVal = document.createElement('td'); tdVal.textContent = parseFloat(r.hours).toFixed(1);
				tr.appendChild(tdProj); tr.appendChild(tdWp); tr.appendChild(tdVal);
				previewBody.appendChild(tr);
			});
			assignedEl.textContent = parseFloat(data.assigned_total).toFixed(1);
			const remaining = parseFloat(data.remaining);
			remainingEl.textContent = remaining.toFixed(1);
			if (remaining < 0) remainingEl.classList.add('text-danger'); else remainingEl.classList.remove('text-danger');
		} catch (e) {
			console.error('Preview fetch failed', e);
		}
	}

	const debouncedPreview = debounce(fetchPreview, 300);
	inputs.forEach(i => i.addEventListener('input', debouncedPreview));
	// initial preview
	fetchPreview();
});
</script>
</html>
